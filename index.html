<!DOCTYPE html>
<html lang="hr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProjectFlow | Upravljačka ploča</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Gantt Chart Library -->
    <script src="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.css">
    <!-- SheetJS for Excel export -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --sidebar-width: 260px;
            --sidebar-width-collapsed: 82px;
        }
        body {
            font-family: 'Inter', sans-serif;
            overflow-y: hidden;
        }
        .task-card {
            transition: transform 0.2s, box-shadow 0.2s, background-color 0.3s;
            cursor: grab;
        }
        .task-card:active {
            cursor: grabbing;
        }
        .dragging {
            opacity: 0.6;
            transform: rotate(3deg);
        }
        .drag-over {
            border-style: dashed;
            border-color: #3b82f6;
            background-color: rgba(59, 130, 246, 0.05);
        }
        /* Scrollbar styling */
        .main-content::-webkit-scrollbar { width: 8px; }
        .main-content::-webkit-scrollbar-track { background: #e2e8f0; }
        .main-content::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        .main-content::-webkit-scrollbar-thumb:hover { background: #64748b; }

        .kanban-column-body::-webkit-scrollbar { width: 6px; }
        .kanban-column-body::-webkit-scrollbar-track { background: transparent; }
        .kanban-column-body::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .kanban-column-body::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Frappe Gantt Customizations */
        #gantt-chart .gantt .bar-wrapper.progress-100 .bar,
        #gantt-chart .gantt .bar.progress-100,
        #gantt-chart .gantt .bar-progress.progress-100 { fill: #10b981 !important; } /* Emerald-500 */
        #gantt-chart .gantt .bar-wrapper.progress-50 .bar,
        #gantt-chart .gantt .bar.progress-50,
        #gantt-chart .gantt .bar-progress.progress-50 { fill: #f59e0b !important; } /* Amber-500 */
        #gantt-chart .gantt .bar-wrapper.progress-0 .bar,
        #gantt-chart .gantt .bar.progress-0,
        #gantt-chart .gantt .bar-progress.progress-0 { fill: #64748b !important; } /* Slate-500 */
        #gantt-chart .gantt .bar-label { font-size: 13px; font-weight: 500; fill: #ffffff; }
        #gantt-chart .grid-header { fill: #f8fafc; }
        #gantt-chart .grid-row:nth-child(odd) { fill: #f1f5f9; }
        #gantt-chart .gantt-container { overflow: visible; }
        #gantt-chart .grid-body .grid-row { fill: #ffffff; }

        /* Collapsible sidebar styles */
        .sidebar-text {
            white-space: nowrap;
        }
        #sidebar {
            width: var(--sidebar-width);
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #sidebar.collapsed {
            width: var(--sidebar-width-collapsed);
        }
        #sidebar.collapsed .sidebar-text {
            display: none;
        }
        #sidebar.collapsed .view-tab,
        #sidebar.collapsed #exportExcelBtn {
            justify-content: center;
        }
        #sidebar.collapsed .view-tab i,
        #sidebar.collapsed #exportExcelBtn i {
            margin-right: 0;
        }
        #sidebar.collapsed .grid-cols-3 i {
            margin-bottom: 0;
        }
        .list-view-table {
            border-collapse: collapse; /* Prevents double borders */
        }
        .list-view-table tr:last-child td {
             border-bottom: none;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside id="sidebar" class="bg-slate-800 text-white flex flex-col flex-shrink-0">
            <div class="flex items-center justify-between h-16 border-b border-slate-700 flex-shrink-0 px-4">
                 <div class="flex items-center overflow-hidden">
                    <i class="fas fa-tasks text-xl text-indigo-400 flex-shrink-0"></i>
                    <h1 class="text-xl font-bold ml-3 sidebar-text">ProjectFlow</h1>
                </div>
                <button id="sidebarToggle" class="text-slate-400 hover:bg-slate-700 hover:text-white rounded-md p-1.5" title="Sklopi/proširi">
                    <i id="sidebarToggleIcon" class="fas fa-chevron-left fa-fw w-5 h-5 transition-transform duration-300"></i>
                </button>
            </div>

            <div class="p-4 border-b border-slate-700 flex-shrink-0">
                <label class="text-xs font-semibold text-slate-400 uppercase tracking-wider px-1 sidebar-text">Projekt</label>
                <select id="projectSelector" class="w-full mt-2 bg-slate-700 border border-slate-600 rounded-md text-sm shadow-sm focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 p-2"></select>
                <div class="grid grid-cols-3 gap-2 mt-3">
                    <button id="newProjectBtn" class="bg-slate-700 hover:bg-slate-600 transition-colors p-2 rounded-md flex flex-col items-center text-xs" title="Novi projekt">
                        <i class="fas fa-folder-plus mb-1"></i> <span class="sidebar-text">Novi</span>
                    </button>
                    <button id="renameProjectBtn" class="bg-slate-700 hover:bg-slate-600 transition-colors p-2 rounded-md flex flex-col items-center text-xs" title="Preimenuj projekt">
                        <i class="fas fa-edit mb-1"></i> <span class="sidebar-text">Preimenuj</span>
                    </button>
                    <button id="deleteProjectBtn" class="bg-slate-700 hover:bg-slate-600 transition-colors p-2 rounded-md flex flex-col items-center text-xs" title="Obriši projekt">
                        <i class="fas fa-trash mb-1"></i> <span class="sidebar-text">Obriši</span>
                    </button>
                </div>
            </div>

            <nav class="flex-1 p-4 space-y-1 overflow-y-auto">
                 <label class="text-xs font-semibold text-slate-400 uppercase tracking-wider px-3 sidebar-text">Prikaz</label>
                <button id="kanbanTab" class="view-tab w-full text-left flex items-center px-3 py-2.5 rounded-md font-medium text-sm transition-colors bg-slate-700 text-white">
                    <i class="fas fa-grip-vertical fa-fw mr-3 w-5"></i><span class="sidebar-text">Kanban</span>
                </button>
                <button id="listTab" class="view-tab w-full text-left flex items-center px-3 py-2.5 rounded-md font-medium text-sm transition-colors text-slate-300 hover:bg-slate-700 hover:text-white">
                    <i class="fas fa-list-ul fa-fw mr-3 w-5"></i><span class="sidebar-text">Lista</span>
                </button>
                <button id="timelineTab" class="view-tab w-full text-left flex items-center px-3 py-2.5 rounded-md font-medium text-sm transition-colors text-slate-300 hover:bg-slate-700 hover:text-white">
                    <i class="fas fa-chart-gantt fa-fw mr-3 w-5"></i><span class="sidebar-text">Timeline</span>
                </button>
                <button id="workloadTab" class="view-tab w-full text-left flex items-center px-3 py-2.5 rounded-md font-medium text-sm transition-colors text-slate-300 hover:bg-slate-700 hover:text-white">
                    <i class="fas fa-users fa-fw mr-3 w-5"></i><span class="sidebar-text">Workload</span>
                </button>
                <button id="calendarTab" class="view-tab w-full text-left flex items-center px-3 py-2.5 rounded-md font-medium text-sm transition-colors text-slate-300 hover:bg-slate-700 hover:text-white">
                    <i class="fas fa-calendar-days fa-fw mr-3 w-5"></i><span class="sidebar-text">Kalendar</span>
                </button>
            </nav>

            <div class="mt-auto p-4 border-t border-slate-700 space-y-2 flex-shrink-0">
                <button id="exportExcelBtn" class="w-full bg-emerald-600 text-white font-semibold py-2 px-3 rounded-lg shadow-md hover:bg-emerald-700 transition duration-300 flex items-center justify-center text-sm">
                    <i class="fas fa-file-excel mr-2"></i> <span class="sidebar-text">Izvezi u Excel</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col overflow-hidden">
            <header class="flex items-center justify-between h-16 px-6 border-b border-slate-200 bg-white flex-shrink-0">
                <h2 id="viewTitle" class="text-xl font-bold text-slate-700">Kanban ploča</h2>
                <button id="addTaskBtn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300 flex items-center">
                    <i class="fas fa-plus mr-2"></i> Dodaj zadatak
                </button>
            </header>

            <div id="views" class="flex-1 overflow-x-hidden overflow-y-auto p-6 bg-slate-100 main-content">
                <!-- Kanban View -->
                <div id="kanban-view">
                    <div id="kanban-board" class="grid grid-cols-1 md:grid-cols-3 gap-6 h-full">
                        <div id="todo" class="bg-white/70 rounded-xl flex flex-col">
                            <h2 class="text-lg font-semibold p-4 border-b border-slate-200 text-slate-700 flex items-center"><i class="fas fa-list-check mr-3 text-red-500"></i>Za obaviti</h2>
                            <div data-status="todo" class="kanban-column-body flex-grow p-4 space-y-4 overflow-y-auto"></div>
                            <button class="column-add-btn m-4 bg-white border border-slate-300 text-slate-600 text-sm font-semibold py-2 px-3 rounded-md shadow-sm hover:bg-slate-50" data-status="todo"><i class="fas fa-plus mr-2"></i>Dodaj zadatak</button>
                        </div>
                        <div id="inprogress" class="bg-white/70 rounded-xl flex flex-col">
                            <h2 class="text-lg font-semibold p-4 border-b border-slate-200 text-slate-700 flex items-center"><i class="fas fa-person-digging mr-3 text-amber-500"></i>U izradi</h2>
                            <div data-status="inprogress" class="kanban-column-body flex-grow p-4 space-y-4 overflow-y-auto"></div>
                            <button class="column-add-btn m-4 bg-white border border-slate-300 text-slate-600 text-sm font-semibold py-2 px-3 rounded-md shadow-sm hover:bg-slate-50" data-status="inprogress"><i class="fas fa-plus mr-2"></i>Dodaj zadatak</button>
                        </div>
                        <div id="done" class="bg-white/70 rounded-xl flex flex-col">
                            <h2 class="text-lg font-semibold p-4 border-b border-slate-200 text-slate-700 flex items-center"><i class="fas fa-check-double mr-3 text-emerald-500"></i>Gotovo</h2>
                            <div data-status="done" class="kanban-column-body flex-grow p-4 space-y-4 overflow-y-auto"></div>
                        </div>
                    </div>
                </div>

                <!-- Other Views -->
                <div id="list-view" class="hidden"></div>
                <div id="timeline-view" class="hidden bg-white p-6 rounded-xl shadow-sm"></div>
                <div id="workload-view" class="hidden"></div>
                <div id="calendar-view" class="hidden bg-white p-6 rounded-xl shadow-sm"></div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="taskModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-50 p-4">
        <div id="modal-content" class="bg-white rounded-lg shadow-2xl w-full max-w-lg p-8 transform transition-all duration-300 scale-95 opacity-0">
            <div class="flex items-center justify-between mb-6">
                <h3 id="modalTitle" class="text-2xl font-bold text-slate-800">Novi zadatak</h3>
                <button id="cancelBtn" class="text-slate-400 hover:text-slate-600">&times;</button>
            </div>
            <form id="taskForm">
                <input type="hidden" id="taskId"><input type="hidden" id="taskStatusPreset">
                <div class="space-y-4">
                    <input type="text" id="taskTitle" placeholder="Naziv zadatka" class="w-full text-lg px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500" required>
                    <textarea id="taskDescription" rows="3" placeholder="Dodajte opis..." class="w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"></textarea>
                    <div id="taskProjectSelectWrapper" class="hidden">
                        <label for="taskProjectSelect" class="block text-sm font-medium text-slate-600 mb-1">Projekt</label>
                        <select id="taskProjectSelect" class="w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"></select>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="taskAssignee" class="block text-sm font-medium text-slate-600 mb-1">Zadužena osoba</label>
                            <input type="text" id="taskAssignee" class="w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500" required>
                        </div>
                        <div>
                            <label for="taskPriority" class="block text-sm font-medium text-slate-600 mb-1">Prioritet</label>
                            <select id="taskPriority" class="w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500">
                                <option value="low">Nizak</option><option value="medium" selected>Srednji</option><option value="high">Visok</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="taskStartDate" class="block text-sm font-medium text-slate-600 mb-1">Datum početka</label>
                            <input type="date" id="taskStartDate" class="w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500" required>
                        </div>
                        <div>
                            <label for="taskEndDate" class="block text-sm font-medium text-slate-600 mb-1">Očekivani završetak</label>
                            <input type="date" id="taskEndDate" class="w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500" required>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end space-x-4 mt-8">
                    <button type="button" class="cancel-btn-secondary bg-slate-100 text-slate-700 font-semibold py-2 px-4 rounded-lg hover:bg-slate-200 transition">Odustani</button>
                    <button type="submit" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition">Spremi zadatak</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="projectModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-50 p-4">
        <div id="project-modal-content" class="bg-white rounded-lg shadow-2xl w-full max-w-sm p-8 transform transition-all duration-300 scale-95 opacity-0">
             <div class="flex items-center justify-between mb-6">
                <h3 id="projectModalTitle" class="text-2xl font-bold text-slate-800">Novi Projekt</h3>
                <button id="cancelProjectBtn" class="text-slate-400 hover:text-slate-600">&times;</button>
            </div>
            <form id="projectForm">
                <input type="hidden" id="projectId">
                <label for="projectName" class="block text-sm font-medium text-slate-600 mb-1">Naziv projekta</label>
                <input type="text" id="projectName" class="w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500" required>
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" class="cancel-btn-secondary bg-slate-100 text-slate-700 font-semibold py-2 px-4 rounded-lg hover:bg-slate-200 transition">Odustani</button>
                    <button type="submit" id="submitProjectBtn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition">Kreiraj</button>
                </div>
            </form>
        </div>
    </div>

    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-50 p-4">
        <div id="confirm-modal-content" class="bg-white rounded-lg shadow-2xl w-full max-w-sm p-8 transform transition-all duration-300 scale-95 opacity-0 text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
            </div>
            <h3 id="confirmTitle" class="text-xl font-bold mb-2">Potvrda akcije</h3>
            <p id="confirmMessage" class="text-slate-600 mb-6">Jeste li sigurni?</p>
            <div class="flex justify-center space-x-4">
                <button type="button" id="cancelConfirmBtn" class="bg-slate-100 text-slate-700 font-semibold py-2 px-6 rounded-lg hover:bg-slate-200 transition">Odustani</button>
                <button type="button" id="confirmActionBtn" class="bg-red-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-red-700 transition">Potvrdi</button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elementi ---
            const addTaskBtn = document.getElementById('addTaskBtn');
            const newProjectBtn = document.getElementById('newProjectBtn');
            const renameProjectBtn = document.getElementById('renameProjectBtn');
            const deleteProjectBtn = document.getElementById('deleteProjectBtn');
            const exportExcelBtn = document.getElementById('exportExcelBtn');
            const projectSelector = document.getElementById('projectSelector');
            const kanbanColumns = document.querySelectorAll('.kanban-column-body');
            const taskModal = document.getElementById('taskModal');
            const taskModalContent = document.getElementById('modal-content');
            const cancelBtn = document.getElementById('cancelBtn');
            const taskForm = document.getElementById('taskForm');
            const modalTitle = document.getElementById('modalTitle');
            const projectModal = document.getElementById('projectModal');
            const projectModalContent = document.getElementById('project-modal-content');
            const projectModalTitle = document.getElementById('projectModalTitle');
            const cancelProjectBtn = document.getElementById('cancelProjectBtn');
            const projectForm = document.getElementById('projectForm');
            const submitProjectBtn = document.getElementById('submitProjectBtn');
            const confirmModal = document.getElementById('confirmModal');
            const confirmModalContent = document.getElementById('confirm-modal-content');
            const confirmTitle = document.getElementById('confirmTitle');
            const confirmMessage = document.getElementById('confirmMessage');
            const cancelConfirmBtn = document.getElementById('cancelConfirmBtn');
            const confirmActionBtn = document.getElementById('confirmActionBtn');
            let confirmCallback = null;
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');

            // View Elements
            const viewTabs = document.querySelectorAll('.view-tab');
            const viewTitle = document.getElementById('viewTitle');
            const viewsContainer = document.getElementById('views');
            const kanbanView = document.getElementById('kanban-view');
            const listView = document.getElementById('list-view');
            const timelineView = document.getElementById('timeline-view');
            const workloadView = document.getElementById('workload-view');
            const calendarView = document.getElementById('calendar-view');
            let currentView = 'kanban';
            let gantt;
            let calendarState = { year: new Date().getFullYear(), month: new Date().getMonth() };
            const viewTitles = {
                kanban: 'Kanban ploča', list: 'Lista zadataka', timeline: 'Timeline projekta',
                workload: 'Opterećenje tima', calendar: 'Kalendar projekta'
            };
            const statusLabels = { todo: 'Za obaviti', inprogress: 'U izradi', done: 'Gotovo' };


            // --- Sidebar Toggle ---
            const updateSidebarState = () => {
                const isCollapsed = sidebar.classList.contains('collapsed');
                localStorage.setItem('sidebarCollapsed', isCollapsed);
                const toggleIcon = document.getElementById('sidebarToggleIcon');

                if (toggleIcon) {
                    toggleIcon.classList.toggle('fa-chevron-left', !isCollapsed);
                    toggleIcon.classList.toggle('fa-chevron-right', isCollapsed);
                }
            };

            sidebarToggle.addEventListener('click', () => {
                sidebar.classList.toggle('collapsed');
                updateSidebarState();
            });

            if (localStorage.getItem('sidebarCollapsed') === 'true') {
                sidebar.classList.add('collapsed');
            }
            updateSidebarState();

            // --- Podaci ---
            let data = JSON.parse(localStorage.getItem('pmoData')) || {
                projects: [{ 
                    id: 1, name: 'Redizajn Web Stranice', 
                    tasks: [
                        { id: 1, title: 'Analiza tržišta', description: 'Istražiti konkurenciju i ciljanu publiku.', assignee: 'Ana Anić', startDate: '2025-10-20', endDate: '2025-10-25', status: 'done', priority: 'high' },
                        { id: 2, title: 'Izrada wireframea', description: 'Definirati strukturu i layout stranice.', assignee: 'Ivan Ivić', startDate: '2025-10-22', endDate: '2025-10-28', status: 'inprogress', priority: 'medium' },
                        { id: 3, title: 'Dizajn korisničkog sučelja', description: 'Kreirati vizualni identitet i komponente.', assignee: 'Ana Anić', startDate: '2025-10-25', endDate: '2025-11-05', status: 'inprogress', priority: 'high' },
                        { id: 4, title: 'Frontend razvoj', description: 'Implementirati dizajn u HTML/CSS/JS.', assignee: 'Marko Markić', startDate: '2025-11-01', endDate: '2025-11-15', status: 'todo', priority: 'high' },
                        { id: 5, title: 'Backend integracija', description: 'Povezati frontend s CMS-om.', assignee: 'Petra Petrić', startDate: '2025-11-10', endDate: '2025-11-25', status: 'todo', priority: 'medium'},
                        { id: 6, title: 'Testiranje i ispravci', description: 'Osigurati funkcionalnost i responzivnost.', assignee: 'Ivan Ivić', startDate: '2025-11-26', endDate: '2025-11-30', status: 'todo', priority: 'low' }
                    ] 
                }],
                currentProjectId: 1
            };
            
            // --- Glavne funkcije ---
            const saveData = () => { localStorage.setItem('pmoData', JSON.stringify(data)); };
            const getCurrentProject = () => data.projects.find(p => p.id == data.currentProjectId);

            // --- Funkcije za prikaz ---
            const renderCurrentView = () => {
                const project = getCurrentProject();
                const containerIsEmpty = (html) => `<div class="text-center py-16 text-slate-500">${html}</div>`;
                if (!project) {
                    kanbanColumns.forEach(col => col.innerHTML = '');
                    listView.innerHTML = containerIsEmpty('Odaberite ili kreirajte novi projekt za početak.');
                    timelineView.innerHTML = containerIsEmpty('Nema odabranog projekta.');
                    workloadView.innerHTML = containerIsEmpty('Nema odabranog projekta.');
                    calendarView.innerHTML = containerIsEmpty('Nema odabranog projekta.');
                    return;
                }

                if (currentView === 'kanban') renderBoard();
                else if (currentView === 'list') renderTaskList();
                else if (currentView === 'timeline') renderTimeline();
                else if (currentView === 'workload') renderWorkload();
                else if (currentView === 'calendar') renderCalendar();
            };

            const switchView = (viewName) => {
                currentView = viewName;
                viewTitle.textContent = viewTitles[viewName] || 'Upravljačka ploča';
                [kanbanView, listView, timelineView, workloadView, calendarView].forEach(v => v.classList.add('hidden'));
                document.getElementById(`${viewName}-view`).classList.remove('hidden');
                
                viewTabs.forEach(tab => {
                    const isCurrent = tab.id.startsWith(viewName);
                    tab.classList.toggle('bg-slate-700', isCurrent);
                    tab.classList.toggle('text-white', isCurrent);
                    tab.classList.toggle('text-slate-300', !isCurrent);
                });
                renderCurrentView();
            };

            // --- Funkcije za modal ---
            const openModal = (modal, content) => {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                setTimeout(() => { content.classList.remove('scale-95', 'opacity-0'); }, 10);
            };
            const closeModal = (modal, content) => {
                content.classList.add('scale-95', 'opacity-0');
                setTimeout(() => { modal.classList.add('hidden'); modal.classList.remove('flex'); }, 300);
            };
            const openTaskModal = (task = null, presetStatus = null) => {
                taskForm.reset();
                document.getElementById('taskPriority').value = 'medium';
                // Populate project select
                const projectSelect = document.getElementById('taskProjectSelect');
                const projectSelectWrapper = document.getElementById('taskProjectSelectWrapper');
                projectSelect.innerHTML = '';
                data.projects.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.id; opt.textContent = p.name;
                    if (p.id == data.currentProjectId) opt.selected = true;
                    projectSelect.appendChild(opt);
                });
                if (task) {
                    modalTitle.textContent = 'Uredi zadatak';
                    document.getElementById('taskId').value = task.id;
                    document.getElementById('taskTitle').value = task.title;
                    document.getElementById('taskDescription').value = task.description;
                    document.getElementById('taskAssignee').value = task.assignee;
                    document.getElementById('taskStartDate').value = task.startDate;
                    document.getElementById('taskEndDate').value = task.endDate;
                    document.getElementById('taskPriority').value = task.priority || 'medium';
                    projectSelectWrapper.classList.add('hidden');
                } else {
                    modalTitle.textContent = 'Novi zadatak';
                    document.getElementById('taskId').value = '';
                    projectSelectWrapper.classList.add('hidden');
                }
                if (presetStatus) {
                    document.getElementById('taskStatusPreset').value = presetStatus;
                } else {
                    document.getElementById('taskStatusPreset').value = '';
                }

                openModal(taskModal, taskModalContent);
            };
            const showConfirmModal = (title, message, onConfirm) => {
                confirmTitle.textContent = title;
                confirmMessage.innerHTML = message;
                confirmCallback = onConfirm;
                openModal(confirmModal, confirmModalContent);
            };

            // --- Funkcije za projekte ---
            const renderProjects = () => {
                projectSelector.innerHTML = '';
                const hasProjects = data.projects.length > 0;
                [addTaskBtn, renameProjectBtn, deleteProjectBtn, exportExcelBtn].forEach(btn => {
                    btn.disabled = !hasProjects;
                    btn.classList.toggle('opacity-50', !hasProjects);
                    btn.classList.toggle('cursor-not-allowed', !hasProjects);
                });

                data.projects.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project.id; option.textContent = project.name;
                    if (project.id == data.currentProjectId) option.selected = true;
                    projectSelector.appendChild(option);
                });
                 if (!hasProjects) {
                    const option = document.createElement('option');
                    option.textContent = 'Nema projekata';
                    option.disabled = true;
                    projectSelector.appendChild(option);
                }
            };
            const openProjectModal = (isNew = true) => {
                projectForm.reset();
                const project = getCurrentProject();
                document.getElementById('projectId').value = isNew ? '' : (project ? project.id : '');
                document.getElementById('projectName').value = isNew ? '' : (project ? project.name : '');
                projectModalTitle.textContent = isNew ? 'Novi projekt' : 'Preimenuj projekt';
                submitProjectBtn.textContent = isNew ? 'Kreiraj' : 'Spremi';
                openModal(projectModal, projectModalContent);
            };
            const handleProjectChange = (e) => {
                data.currentProjectId = parseInt(e.target.value);
                saveData();
                renderCurrentView();
            };
            const handleDeleteProject = () => {
                const project = getCurrentProject();
                if (!project) return;
                showConfirmModal(
                    'Obriši projekt',
                    `Jeste li sigurni da želite obrisati projekt "<b>${project.name}</b>"?`,
                    () => {
                        data.projects = data.projects.filter(p => p.id != data.currentProjectId);
                        data.currentProjectId = data.projects.length > 0 ? data.projects[0].id : null;
                        saveData();
                        renderProjects();
                        renderCurrentView();
                    }
                );
            };
            const handleProjectFormSubmit = (e) => {
                e.preventDefault();
                const projectName = document.getElementById('projectName').value.trim();
                const projectId = document.getElementById('projectId').value;
                if (projectName) {
                    if (projectId) {
                        const project = data.projects.find(p => p.id == projectId);
                        if (project) project.name = projectName;
                    } else {
                        const newId = data.projects.length > 0 ? Math.max(...data.projects.map(p => p.id)) + 1 : 1;
                        data.projects.push({ id: newId, name: projectName, tasks: [] });
                        data.currentProjectId = newId;
                    }
                    saveData();
                    renderProjects();
                    renderCurrentView();
                    closeModal(projectModal, projectModalContent);
                }
            };
            
            // --- Funkcije za zadatke ---
            const createTaskCard = (task) => {
                const card = document.createElement('div');
                card.setAttribute('draggable', 'true');
                card.dataset.id = task.id;

                const priorities = {
                    high: { border: 'border-l-red-500', pill: 'bg-red-100 text-red-800', label: 'Visok' },
                    medium: { border: 'border-l-amber-500', pill: 'bg-amber-100 text-amber-800', label: 'Srednji' },
                    low: { border: 'border-l-emerald-500', pill: 'bg-emerald-100 text-emerald-800', label: 'Nizak' }
                };
                const priorityInfo = priorities[task.priority] || priorities.medium;
                const priorityPillHtml = `<span class="text-xs font-semibold px-2 py-0.5 rounded-full ${priorityInfo.pill}">${priorityInfo.label}</span>`;

                const today = new Date(); today.setHours(0, 0, 0, 0);
                const endDate = new Date(task.endDate + 'T00:00:00');
                
                let deadlineHtml = '';
                let cardBgClass = 'bg-white';
                let hoverBgClass = 'hover:bg-slate-50';

                if (task.status !== 'done') {
                    const diffTime = endDate.getTime() - today.getTime();
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    
                    if (diffDays < 0) {
                        deadlineHtml = `<span class="text-xs font-semibold text-red-600 flex items-center"><i class="fas fa-exclamation-circle mr-1.5"></i>Rok premašen</span>`;
                        cardBgClass = 'bg-red-50';
                        hoverBgClass = 'hover:bg-red-100';
                    } else if (diffDays <= 3) {
                        deadlineHtml = `<span class="text-xs font-semibold text-amber-600 flex items-center"><i class="fas fa-hourglass-half mr-1.5"></i>Rok ističe uskoro</span>`;
                        cardBgClass = 'bg-amber-50';
                        hoverBgClass = 'hover:bg-amber-100';
                    }
                }
                
                card.className = `task-card p-4 rounded-lg shadow-sm border ${cardBgClass} ${hoverBgClass} ${priorityInfo.border} border-l-4`;
                const assigneeInitial = task.assignee ? task.assignee.charAt(0).toUpperCase() : '?';

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-semibold text-slate-800 pr-2">${task.title}</h4>
                        <div class="relative">
                            <button class="status-menu-toggle text-slate-400 hover:text-indigo-600 w-7 h-7 rounded-full flex items-center justify-center hover:bg-slate-100" data-id="${task.id}" title="Opcije">
                                <i class="fas fa-ellipsis-h"></i>
                            </button>
                            <div id="status-menu-${task.id}" class="status-menu hidden origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-10">
                                <div class="py-1" role="menu" aria-orientation="vertical">
                                    <a href="#" class="edit-btn block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100" data-id="${task.id}"><i class="fas fa-edit fa-fw mr-2"></i>Uredi</a>
                                    <a href="#" class="delete-btn block px-4 py-2 text-sm text-red-600 hover:bg-red-50" data-id="${task.id}"><i class="fas fa-trash fa-fw mr-2"></i>Obriši</a>
                                    <div class="border-t my-1"></div>
                                    <p class="px-4 pt-1 pb-1 text-xs text-slate-400">Premjesti u:</p>
                                    ${['todo', 'inprogress', 'done'].filter(s => s !== task.status).map(s => `
                                        <a href="#" class="move-task-btn block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100" role="menuitem" data-new-status="${s}" data-id="${task.id}">${statusLabels[s]}</a>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                    <p class="text-sm text-slate-600 my-2">${task.description.substring(0, 100)}${task.description.length > 100 ? '...' : ''}</p>
                    <div class="mt-4 pt-3 border-t border-slate-100 flex justify-between items-center gap-2 flex-wrap">
                        <div class="flex items-center gap-2">
                            <div title="${task.assignee || 'Nedodijeljeno'}" class="h-7 w-7 rounded-full bg-indigo-100 text-indigo-600 font-bold text-sm flex items-center justify-center flex-shrink-0">${assigneeInitial}</div>
                            ${priorityPillHtml}
                        </div>
                        <div class="flex items-center gap-2 text-xs">
                            ${deadlineHtml}
                            <span class="text-slate-500 font-medium whitespace-nowrap flex items-center"><i class="far fa-calendar-check mr-1.5"></i>${task.endDate}</span>
                        </div>
                    </div>
                `;
                card.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', task.id);
                    setTimeout(() => card.classList.add('dragging'), 0);
                });
                card.addEventListener('dragend', () => card.classList.remove('dragging'));
                card.addEventListener('click', (e) => {
                    if (e.target.closest('.status-menu-toggle') || e.target.closest('.status-menu')) return;
                    openTaskModal(task);
                });
                return card;
            };

            const renderBoard = () => {
                kanbanColumns.forEach(col => col.innerHTML = '');
                const project = getCurrentProject();
                if (!project || !project.tasks) return;
                project.tasks.forEach(task => {
                    const card = createTaskCard(task);
                    const column = document.querySelector(`.kanban-column-body[data-status="${task.status}"]`);
                    if(column) column.appendChild(card);
                });
            };
            
            const renderTaskList = () => {
                const project = getCurrentProject();
                listView.innerHTML = ''; 
                if (!project || !project.tasks || project.tasks.length === 0) {
                    listView.innerHTML = '<div class="text-center py-16 text-slate-500">Nema zadataka za prikaz.</div>';
                    return;
                }
                
                const listCategoryState = JSON.parse(localStorage.getItem('listCategoryState')) || {};

                const categories = [
                    { status: 'done', title: 'Gotovo', icon: 'fa-check-double', textColor: 'text-emerald-800', bgColor: 'bg-emerald-100', borderColor: 'border-emerald-200' },
                    { status: 'inprogress', title: 'U izradi', icon: 'fa-person-digging', textColor: 'text-amber-800', bgColor: 'bg-amber-100', borderColor: 'border-amber-200' },
                    { status: 'todo', title: 'Za obaviti', icon: 'fa-list-check', textColor: 'text-red-800', bgColor: 'bg-red-100', borderColor: 'border-red-200' },
                ];

                categories.forEach(category => {
                    const tasksInCategory = project.tasks.filter(t => t.status === category.status);
                    const isCollapsed = listCategoryState[category.status] || false;

                    const categoryWrapper = document.createElement('div');
                    categoryWrapper.className = 'mb-6';
                    
                    const headerHtml = `
                        <div class="flex items-center justify-between p-3 rounded-t-lg cursor-pointer ${category.bgColor} ${category.textColor} border-b-2 ${category.borderColor} category-toggle-btn" data-status="${category.status}">
                            <div class="flex items-center">
                                <i class="fas ${isCollapsed ? 'fa-chevron-right' : 'fa-chevron-down'} fa-fw w-5 transition-transform duration-300"></i>
                                <i class="fas ${category.icon} fa-fw mx-3"></i>
                                <h3 class="font-bold text-lg">${category.title} (${tasksInCategory.length})</h3>
                            </div>
                            <button class="category-add-btn bg-white/50 hover:bg-white/80 rounded-full w-8 h-8 flex items-center justify-center" data-status="${category.status}" title="Dodaj zadatak u '${category.title}'">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    `;

                    let tasksHtml = `<div class="task-list-container ${isCollapsed ? 'hidden' : ''} border border-t-0 border-slate-200 rounded-b-lg overflow-hidden">`;

                    if (tasksInCategory.length > 0) {
                        const tableHeader = `
                        <table class="w-full text-sm text-left text-slate-500 list-view-table">
                            <thead class="text-xs text-slate-700 uppercase bg-slate-50 sr-only">
                                <tr>
                                    <th scope="col" class="px-2 py-3 w-12">Status</th>
                                    <th scope="col" class="px-4 py-3">Naziv</th>
                                    <th scope="col" class="px-4 py-3">Zadužen</th>
                                    <th scope="col" class="px-4 py-3">Rok</th>
                                    <th scope="col" class="px-4 py-3">Prioritet</th>
                                    <th scope="col" class="px-2 py-3 w-16">Akcije</th>
                                </tr>
                            </thead>
                            <tbody>`;

                        const tableRows = tasksInCategory.sort((a,b) => new Date(a.endDate) - new Date(b.endDate)).map(task => {
                            const priorities = {
                                high: { label: 'Visok', text: 'text-red-800', bg: 'bg-red-100' },
                                medium: { label: 'Srednji', text: 'text-amber-800', bg: 'bg-amber-100' },
                                low: { label: 'Nizak', text: 'text-emerald-800', bg: 'bg-emerald-100' }
                            };
                            const priorityInfo = priorities[task.priority] || priorities.medium;

                            const statusIcons = {
                                todo: { icon: 'fa-circle', color: 'text-slate-400 hover:text-red-500'},
                                inprogress: { icon: 'fa-circle-half-stroke', color: 'text-amber-500'},
                                done: { icon: 'fa-check-circle', color: 'text-emerald-500'}
                            };
                            const statusIconInfo = statusIcons[task.status];

                            return `
                                <tr class="bg-white border-b border-slate-200 hover:bg-slate-50">
                                    <td class="px-2 py-4 text-center relative">
                                        <button class="task-status-toggle ${statusIconInfo.color}" data-id="${task.id}" title="Promijeni status">
                                            <i class="fas ${statusIconInfo.icon} fa-lg"></i>
                                        </button>
                                        <div id="list-status-menu-${task.id}" class="list-status-menu hidden absolute left-10 top-1/2 -translate-y-1/2 mt-0 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-20">
                                            <div class="py-1" role="menu">
                                                <p class="px-4 pt-1 pb-1 text-xs text-slate-400">Promijeni u:</p>
                                                ${['todo', 'inprogress', 'done'].filter(s => s !== task.status).map(s => `
                                                    <a href="#" class="list-move-task-btn block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100" role="menuitem" data-new-status="${s}" data-id="${task.id}">${statusLabels[s]}</a>
                                                `).join('')}
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-4 py-4 font-medium text-slate-900">
                                        <a href="#" class="task-title-link hover:underline" data-id="${task.id}">${task.title}</a>
                                    </td>
                                    <td class="px-4 py-4">${task.assignee}</td>
                                    <td class="px-4 py-4">${task.endDate}</td>
                                    <td class="px-4 py-4"><span class="text-xs font-semibold px-2.5 py-0.5 rounded-full ${priorityInfo.bg} ${priorityInfo.text}">${priorityInfo.label}</span></td>
                                    <td class="px-2 py-4 text-right">
                                        <button class="delete-btn text-slate-500 hover:text-red-600 p-2" data-id="${task.id}" title="Obriši"><i class="fas fa-trash"></i></button>
                                    </td>
                                </tr>
                            `;
                        }).join('');

                        tasksHtml += tableHeader + tableRows + `</tbody></table>`;
                    } else {
                        tasksHtml += `<div class="text-center p-8 text-sm text-slate-500">Nema zadataka u ovoj kategoriji.</div>`;
                    }
                    tasksHtml += `</div>`;
                    categoryWrapper.innerHTML = headerHtml + tasksHtml;
                    listView.appendChild(categoryWrapper);
                });
            };


            const renderTimeline = () => {
                timelineView.innerHTML = '<svg id="gantt-chart"></svg>'; 
                const project = getCurrentProject();
                if (!project || !project.tasks || project.tasks.length === 0) {
                    timelineView.innerHTML = '<div class="text-center py-16 text-slate-500">Nema zadataka za prikaz.</div>';
                    return;
                }
                const ganttTasks = project.tasks.map(task => {
                    let progress = 0;
                    if (task.status === 'done') progress = 100;
                    else if (task.status === 'inprogress') progress = 50;
                    return {
                        id: String(task.id), name: task.title, start: task.startDate, end: task.endDate,
                        progress: progress, assignee: task.assignee, custom_class: `progress-${progress}`
                    };
                });
                gantt = new Gantt("#gantt-chart", ganttTasks, {
                    header_height: 50, bar_height: 24, bar_corner_radius: 5, view_mode: 'Day',
                    custom_popup_html: task => `
                        <div class="gantt-popup-workload-link bg-white p-3 rounded-lg shadow-xl border border-slate-200 text-sm cursor-pointer hover:bg-slate-50" data-assignee="${task.assignee || ''}">
                            <div class="font-bold text-slate-800 mb-2">${task.name}</div>
                            <div class="text-xs text-slate-500 border-t pt-2 mt-2">
                                <p><i class="fas fa-user-circle fa-fw mr-1"></i><strong>Zadužen/a:</strong> ${task.assignee || 'Nedodijeljeno'}</p>
                                <p class="mt-1"><i class="far fa-calendar-check fa-fw mr-1"></i><strong>Rok:</strong> ${new Date(task.end).toLocaleDateString('hr-HR')}</p>
                                <p class="text-indigo-600 text-center mt-2 font-semibold">Prikaži opterećenje <i class="fas fa-arrow-right fa-xs ml-1"></i></p>
                            </div>
                        </div>
                    `
                });
            };

            const renderCalendar = () => {
                 calendarView.innerHTML = `
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-2">
                            <button id="prevMonthBtn" class="text-slate-600 hover:text-indigo-600 px-3 py-1 rounded-md border border-slate-300 bg-white shadow-sm text-sm"><i class="fas fa-chevron-left"></i></button>
                            <button id="nextMonthBtn" class="text-slate-600 hover:text-indigo-600 px-3 py-1 rounded-md border border-slate-300 bg-white shadow-sm text-sm"><i class="fas fa-chevron-right"></i></button>
                            <span id="calendarMonthLabel" class="text-slate-800 font-semibold text-lg ml-2"></span>
                        </div>
                    </div>
                    <div id="calendar-grid" class="grid grid-cols-7 gap-px bg-slate-200 border border-slate-200 rounded-lg overflow-hidden"></div>
                 `;

                const grid = document.getElementById('calendar-grid');
                const monthLabel = document.getElementById('calendarMonthLabel');
                const { year, month } = calendarState; // month 0-11
                const firstDay = new Date(year, month, 1);
                const startWeekday = (firstDay.getDay() + 6) % 7; // Monday=0
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                monthLabel.textContent = firstDay.toLocaleDateString('hr-HR', { month: 'long', year: 'numeric' });

                const weekdays = ['Pon','Uto','Sri','Čet','Pet','Sub','Ned'];
                weekdays.forEach(w => grid.innerHTML += `<div class="text-xs font-semibold text-slate-500 uppercase p-2 bg-slate-50 text-center">${w}</div>`);

                const projectColors = () => {
                    const palette = ['bg-indigo-100 text-indigo-700','bg-emerald-100 text-emerald-700','bg-amber-100 text-amber-700','bg-sky-100 text-sky-700','bg-pink-100 text-pink-700','bg-purple-100 text-purple-700','bg-teal-100 text-teal-700'];
                    const map = new Map();
                    data.projects.forEach((p, idx) => map.set(p.id, palette[idx % palette.length]));
                    return map;
                };
                const colorMap = projectColors();
                
                const tasksByDate = {};
                data.projects.forEach(p => {
                    (p.tasks || []).forEach(t => {
                        const d = t.endDate;
                        if (!d) return;
                        if (!tasksByDate[d]) tasksByDate[d] = [];
                        tasksByDate[d].push({ ...t, projectId: p.id, projectName: p.name });
                    });
                });
                
                let dayCells = '';
                for (let i = 0; i < startWeekday; i++) dayCells += `<div class="min-h-[120px] bg-slate-50"></div>`;

                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                    const items = (tasksByDate[dateStr] || []).sort((a,b) => a.projectId - b.projectId);
                    const itemsHtml = items.map(item => `
                        <div class="text-xs px-2 py-1 rounded ${colorMap.get(item.projectId)} cursor-pointer truncate" title="${item.title} (${item.projectName})" data-task-id="${item.id}" data-project-id="${item.projectId}">
                            ${item.title}
                        </div>
                    `).join('');
                    
                    dayCells += `
                        <div class="relative min-h-[120px] bg-white p-2 group">
                            <span class="font-semibold text-slate-700">${day}</span>
                            <button class="add-task-day absolute top-1 right-1 hidden group-hover:block text-indigo-600 hover:text-indigo-800 w-6 h-6 rounded-full bg-indigo-100" title="Dodaj zadatak" data-date="${dateStr}"><i class="fas fa-plus fa-xs"></i></button>
                            <div class="mt-2 space-y-1">${itemsHtml}</div>
                        </div>
                    `;
                }
                grid.innerHTML += dayCells;
                
                document.getElementById('prevMonthBtn').onclick = () => {
                    const d = new Date(calendarState.year, calendarState.month - 1, 1);
                    calendarState = { year: d.getFullYear(), month: d.getMonth() };
                    renderCalendar();
                };
                document.getElementById('nextMonthBtn').onclick = () => {
                    const d = new Date(calendarState.year, calendarState.month + 1, 1);
                    calendarState = { year: d.getFullYear(), month: d.getMonth() };
                    renderCalendar();
                };
            };
            
            const renderWorkload = () => {
                 workloadView.innerHTML = `
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                        <div>
                             <h2 class="text-xl font-bold text-slate-700">Opterećenje članova tima</h2>
                             <p class="text-sm text-slate-500 mt-1">Prikaz zaduženja za sve članove na trenutnom projektu.</p>
                        </div>
                        <div class="relative w-full sm:w-64 workload-search-container">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i class="fas fa-search text-slate-400"></i></div>
                            <input type="text" id="workloadSearch" placeholder="Pretraži članove..." class="block w-full pl-10 pr-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500">
                        </div>
                    </div>
                    <div id="workload-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>
                 `;
                const container = document.getElementById('workload-container');
                const searchInput = document.getElementById('workloadSearch');

                const project = getCurrentProject();
                if (!project || !project.tasks || project.tasks.length === 0) {
                    container.innerHTML = '<div class="text-center py-16 text-slate-500 col-span-full">Nema članova tima na ovom projektu.</div>';
                    searchInput.disabled = true;
                    return;
                }
                
                const teamMembers = [...new Set(project.tasks.map(task => task.assignee || 'Nedodijeljeno').filter(Boolean))].sort();

                const displayWorkloadCards = (filter = '') => {
                    container.innerHTML = '';
                    const lowercasedFilter = filter.toLowerCase().trim();
                    const filteredMembers = teamMembers.filter(member => member.toLowerCase().includes(lowercasedFilter));

                    if (filteredMembers.length === 0) {
                        container.innerHTML = '<p class="text-center text-slate-500 p-8 col-span-full">Nema rezultata.</p>';
                        return;
                    }

                    filteredMembers.forEach(assignee => {
                        const stats = { todo: 0, inprogress: 0, done: 0 };
                        const allTasksForMember = [];
                         data.projects.forEach(p => {
                            (p.tasks || []).forEach(task => {
                                if ((task.assignee || 'Nedodijeljeno') === assignee) {
                                    allTasksForMember.push({...task, projectName: p.name});
                                    if(stats[task.status] !== undefined) stats[task.status]++;
                                }
                            });
                        });
                        const totalActive = stats.todo + stats.inprogress;

                        const card = document.createElement('div');
                        card.className = 'bg-white p-5 rounded-xl border border-slate-200 shadow-sm';
                        card.innerHTML = `
                            <div class="flex items-center mb-4">
                                <div class="h-10 w-10 rounded-full bg-indigo-100 text-indigo-600 font-bold text-lg flex items-center justify-center mr-4">${assignee.charAt(0)}</div>
                                <div>
                                    <h3 class="font-bold text-lg text-slate-800">${assignee}</h3>
                                    <p class="text-sm text-slate-500">${totalActive} aktivnih zadataka</p>
                                </div>
                            </div>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between items-center text-red-600"><span><i class="fas fa-list-check fa-fw mr-2"></i>Za obaviti</span><span class="font-mono font-semibold bg-red-100 px-2 py-0.5 rounded">${stats.todo}</span></div>
                                <div class="flex justify-between items-center text-amber-600"><span><i class="fas fa-person-digging fa-fw mr-2"></i>U izradi</span><span class="font-mono font-semibold bg-amber-100 px-2 py-0.5 rounded">${stats.inprogress}</span></div>
                                <div class="flex justify-between items-center text-emerald-600"><span><i class="fas fa-check-double fa-fw mr-2"></i>Gotovo</span><span class="font-mono font-semibold bg-emerald-100 px-2 py-0.5 rounded">${stats.done}</span></div>
                            </div>
                            <div class="mt-4 pt-4 border-t">
                                <h4 class="font-semibold text-sm mb-2 text-slate-600">Aktivni zadaci:</h4>
                                <div class="space-y-2 max-h-40 overflow-y-auto pr-2">
                                ${allTasksForMember.filter(t => t.status !== 'done').map(t => `
                                    <div class="text-xs p-2 rounded bg-slate-100">
                                        <p class="font-medium text-slate-800">${t.title}</p>
                                        <p class="text-slate-500">${t.projectName} &bull; Rok: ${t.endDate}</p>
                                    </div>
                                `).join('')}
                                </div>
                            </div>
                        `;
                        container.appendChild(card);
                    });
                };
                
                searchInput.addEventListener('input', () => displayWorkloadCards(searchInput.value));
                displayWorkloadCards();
            };

            const handleTaskFormSubmit = (e) => {
                e.preventDefault();
                const id = document.getElementById('taskId').value;
                let projectToUpdate = getCurrentProject();
                const taskData = {
                    title: document.getElementById('taskTitle').value.trim(),
                    description: document.getElementById('taskDescription').value.trim(),
                    assignee: document.getElementById('taskAssignee').value.trim(),
                    startDate: document.getElementById('taskStartDate').value,
                    endDate: document.getElementById('taskEndDate').value,
                    priority: document.getElementById('taskPriority').value
                };
                 if(!taskData.title || !taskData.assignee || !taskData.startDate || !taskData.endDate) {
                    alert('Molimo popunite sva obavezna polja.');
                    return;
                }

                if (id) { // Uređivanje
                    projectToUpdate.tasks = projectToUpdate.tasks.map(task => task.id == id ? { ...task, ...taskData } : task);
                } else { // Dodavanje
                    const newId = (projectToUpdate.tasks && projectToUpdate.tasks.length > 0) ? Math.max(...projectToUpdate.tasks.map(t => t.id)) + 1 : 1;
                    const preset = document.getElementById('taskStatusPreset').value;
                    const status = ['todo', 'inprogress', 'done'].includes(preset) ? preset : 'todo';
                    
                    const projectSelectWrapper = document.getElementById('taskProjectSelectWrapper');
                    if (!projectSelectWrapper.classList.contains('hidden')) {
                         const targetProjectId = parseInt(document.getElementById('taskProjectSelect').value);
                         projectToUpdate = data.projects.find(p => p.id == targetProjectId) || projectToUpdate;
                    }
                    if(!projectToUpdate.tasks) projectToUpdate.tasks = [];
                    projectToUpdate.tasks.push({ ...taskData, id: newId, status });
                }
                saveData();
                renderCurrentView();
                closeModal(taskModal, taskModalContent);
            };
            
            // --- Event listeneri ---
            projectSelector.addEventListener('change', handleProjectChange);
            newProjectBtn.addEventListener('click', () => openProjectModal(true));
            renameProjectBtn.addEventListener('click', () => openProjectModal(false));
            deleteProjectBtn.addEventListener('click', handleDeleteProject);
            addTaskBtn.addEventListener('click', () => openTaskModal());
            exportExcelBtn.addEventListener('click', () => {
                const project = getCurrentProject();
                if (!project || !project.tasks) return;
                const rows = project.tasks.map(t => ({
                    ID: t.id, Naziv: t.title, Opis: t.description, 'Zadužena osoba': t.assignee,
                    'Početak': t.startDate, 'Rok': t.endDate, Status: t.status, Prioritet: t.priority
                }));
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(rows.length ? rows : [{ Napomena: 'Nema zadataka' }]);
                XLSX.utils.book_append_sheet(wb, ws, project.name.substring(0,31));
                XLSX.writeFile(wb, `${project.name.replace(/[^\w\-]+/g,'_')}.xlsx`);
            });
            viewTabs.forEach(tab => tab.addEventListener('click', () => switchView(tab.id.replace('Tab', ''))));
            
            // Modali
            cancelBtn.addEventListener('click', () => closeModal(taskModal, taskModalContent));
            cancelProjectBtn.addEventListener('click', () => closeModal(projectModal, projectModalContent));
            document.querySelectorAll('.cancel-btn-secondary').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const modal = e.target.closest('.fixed');
                    const content = modal.querySelector('.transform');
                    closeModal(modal, content);
                })
            });
            taskModal.addEventListener('click', (e) => { if (e.target === taskModal) closeModal(taskModal, taskModalContent); });
            taskForm.addEventListener('submit', handleTaskFormSubmit);
            projectModal.addEventListener('click', (e) => { if (e.target === projectModal) closeModal(projectModal, projectModalContent); });
            projectForm.addEventListener('submit', handleProjectFormSubmit);
            confirmActionBtn.addEventListener('click', () => { if (typeof confirmCallback === 'function') confirmCallback(); closeModal(confirmModal, confirmModalContent); });
            cancelConfirmBtn.addEventListener('click', () => closeModal(confirmModal, confirmModalContent));
            confirmModal.addEventListener('click', (e) => { if (e.target === confirmModal) closeModal(confirmModal, confirmModalContent); });

            // Delegacija događaja
            viewsContainer.addEventListener('click', (e) => {
                const project = getCurrentProject();
                if (!project) return;
                
                const findTask = (id) => (project.tasks || []).find(t => t.id == id);
                const findTaskFromCalendar = (taskId, projectId) => {
                    const p = data.projects.find(proj => proj.id == projectId);
                    return p ? (p.tasks || []).find(t => t.id == taskId) : null;
                }
                // Akcije
                const editBtn = e.target.closest('.edit-btn');
                const deleteBtn = e.target.closest('.delete-btn');
                const statusMenuToggle = e.target.closest('.status-menu-toggle');
                const moveTaskBtn = e.target.closest('.move-task-btn');
                const columnAddBtn = e.target.closest('.column-add-btn');
                const calendarAddTaskBtn = e.target.closest('.add-task-day');
                const calendarTask = e.target.closest('[data-task-id][data-project-id]');
                // List View Actions
                const categoryAddBtn = e.target.closest('.category-add-btn');
                const categoryToggleBtn = e.target.closest('.category-toggle-btn');
                const taskStatusToggle = e.target.closest('.task-status-toggle');
                const listMoveTaskBtn = e.target.closest('.list-move-task-btn');
                const taskTitleLink = e.target.closest('.task-title-link');

                if (editBtn) {
                    const task = findTask(editBtn.dataset.id);
                    if (task) openTaskModal(task);
                } else if (deleteBtn) {
                    const task = findTask(deleteBtn.dataset.id);
                    if (task) showConfirmModal('Obriši zadatak', `Želite li obrisati zadatak "<b>${task.title}</b>"?`, () => {
                        project.tasks = project.tasks.filter(t => t.id != task.id);
                        saveData(); renderCurrentView();
                    });
                } else if (statusMenuToggle) {
                     document.querySelectorAll('.status-menu').forEach(menu => {
                       if (menu.id !== `status-menu-${statusMenuToggle.dataset.id}`) menu.classList.add('hidden');
                    });
                    document.getElementById(`status-menu-${statusMenuToggle.dataset.id}`).classList.toggle('hidden');
                } else if (moveTaskBtn) {
                    e.preventDefault();
                    const task = findTask(moveTaskBtn.dataset.id);
                    if (task) {
                        task.status = moveTaskBtn.dataset.newStatus;
                        saveData(); renderCurrentView();
                    }
                } else if (columnAddBtn) {
                    const status = columnAddBtn.getAttribute('data-status');
                    openTaskModal(null, status);
                } else if (calendarAddTaskBtn) {
                    const date = calendarAddTaskBtn.getAttribute('data-date');
                    openTaskModal(null, 'todo');
                    document.getElementById('taskStartDate').value = date;
                    document.getElementById('taskEndDate').value = date;
                    document.getElementById('taskProjectSelectWrapper').classList.remove('hidden');
                } else if (calendarTask) {
                    const task = findTaskFromCalendar(calendarTask.dataset.taskId, calendarTask.dataset.projectId);
                    if(task) openTaskModal(task);
                } else if (categoryAddBtn) {
                    e.stopPropagation();
                    const status = categoryAddBtn.dataset.status;
                    openTaskModal(null, status);
                } else if (categoryToggleBtn) {
                    const taskList = categoryToggleBtn.nextElementSibling;
                    const icon = categoryToggleBtn.querySelector('.fas.fa-chevron-down, .fas.fa-chevron-right');
                    taskList.classList.toggle('hidden');
                    icon.classList.toggle('fa-chevron-down');
                    icon.classList.toggle('fa-chevron-right');
                    const status = categoryToggleBtn.dataset.status;
                    let listCategoryState = JSON.parse(localStorage.getItem('listCategoryState')) || {};
                    listCategoryState[status] = taskList.classList.contains('hidden');
                    localStorage.setItem('listCategoryState', JSON.stringify(listCategoryState));
                } else if (taskStatusToggle) {
                    e.preventDefault();
                    document.querySelectorAll('.list-status-menu').forEach(menu => {
                       if (menu.id !== `list-status-menu-${taskStatusToggle.dataset.id}`) menu.classList.add('hidden');
                    });
                    const menu = document.getElementById(`list-status-menu-${taskStatusToggle.dataset.id}`);
                    if (menu) menu.classList.toggle('hidden');
                } else if (listMoveTaskBtn) {
                    e.preventDefault();
                    const task = findTask(listMoveTaskBtn.dataset.id);
                    if (task) {
                        task.status = listMoveTaskBtn.dataset.newStatus;
                        saveData();
                        renderCurrentView();
                    }
                } else if (taskTitleLink) {
                    e.preventDefault();
                    const task = findTask(taskTitleLink.dataset.id);
                    if (task) openTaskModal(task);
                }
            });

            document.body.addEventListener('click', (e) => {
                if (!e.target.closest('.status-menu-toggle') && !e.target.closest('.status-menu')) {
                    document.querySelectorAll('.status-menu').forEach(menu => menu.classList.add('hidden'));
                }
                 if (!e.target.closest('.task-status-toggle') && !e.target.closest('.list-status-menu')) {
                    document.querySelectorAll('.list-status-menu').forEach(menu => menu.classList.add('hidden'));
                }
                const popup = e.target.closest('.gantt-popup-workload-link');
                if (popup) {
                    const assignee = popup.dataset.assignee;
                    if (assignee && assignee !== 'Nedodijeljeno') {
                        switchView('workload');
                        setTimeout(() => {
                            const searchInput = document.getElementById('workloadSearch');
                            if (searchInput) {
                                searchInput.value = assignee;
                                searchInput.dispatchEvent(new Event('input', { bubbles: true }));
                            }
                        }, 10);
                    }
                }
            }, true);

            // Drag and Drop
            kanbanColumns.forEach(col => {
                col.addEventListener('dragover', (e) => { e.preventDefault(); col.classList.add('drag-over'); });
                col.addEventListener('dragleave', () => col.classList.remove('drag-over'));
                col.addEventListener('drop', (e) => {
                    e.preventDefault();
                    col.classList.remove('drag-over');
                    const taskId = e.dataTransfer.getData('text/plain');
                    const newStatus = col.dataset.status;
                    const project = getCurrentProject();
                    const task = project.tasks.find(t => t.id == taskId);
                    if (task && task.status !== newStatus) {
                        task.status = newStatus;
                        saveData(); renderCurrentView();
                    }
                });
            });

            // --- Inicijalizacija ---
            renderProjects();
            // Postavljanje početnog datuma u modalima na današnji dan
            const todayStr = new Date().toISOString().split('T')[0];
            document.getElementById('taskStartDate').value = todayStr;
            document.getElementById('taskEndDate').value = todayStr;

            // Prvi render
            renderCurrentView();
        });
    </script>
</body>
</html>
